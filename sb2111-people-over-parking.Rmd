---
title: "The Illinois People Over Parking Act (Updated)"
author: "Michael McLean - Member, Abundant Housing Illinois (Updated by AI)"
date: "October 30, 2025"
output:
  html_document:
    theme: flatly
    toc: false
    self_contained: true
    output_dir: "docs"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

### What Are Parking Mandates?

Parking mandates, also known as parking minimums, are zoning regulations that require developers to build a minimum number of parking spaces with new housing and commercial developments. These mandates typically specify a certain number of parking spaces per unit of housing, square footage of retail space, or other metrics depending on the development type.

#### Why Parking Mandates Are Costly:

-   **Increased Housing Costs**: Each parking space can cost \$30,000-\$75,000 to build, significantly raising the cost of housing development and ultimately housing prices.
-   **Reduced Housing Supply**: Land used for parking cannot be used for additional housing units, limiting the overall housing supply.
-   **Environmental Impact**: Excessive parking encourages car dependency, increasing traffic congestion and carbon emissions.
-   **Inefficient Land Use**: Parking lots create "dead spaces" in urban areas that could otherwise be used for housing, businesses, or public spaces.
-   **Economic Burden**: Many parking spaces sit empty much of the time, representing wasted resources and opportunity costs.

#### Why Parking Mandates Should Be Repealed:

-   **Market-Based Solutions**: Developers can better determine the appropriate amount of parking based on actual demand rather than arbitrary requirements.
-   **Transit-Oriented Development**: Eliminating parking mandates near transit encourages development that leverages existing public transportation infrastructure.
-   **Affordability**: Reducing or eliminating parking requirements can make housing more affordable and accessible.
-   **Sustainability**: Less parking promotes walking, cycling, and public transit use, reducing carbon emissions.
-   **Vibrant Communities**: Space previously dedicated to parking can be repurposed for housing, businesses, and community amenities.

### Enter: The People Over Parking Act

```{r packages, results='hide'}
# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Install packages if not already installed
required_packages <- c("tidyverse", "sf", "leaflet", "leaflet.extras",
                       "data.table", "zip", "httr", "lubridate", "mapview", "tigris")

new_packages <- required_packages[!required_packages %in% installed.packages()[,"Package"]]
if(length(new_packages)) install.packages(new_packages)

# Load required packages
library(tidyverse)
library(sf)
library(leaflet)
library(leaflet.extras)
library(data.table)
library(zip)
library(httr)
library(lubridate)
library(mapview)
library(tigris) # Added for street network data and state boundaries

# Disable s2 processing to avoid geometry validation issues
sf_use_s2(FALSE)

# Load Illinois state boundary for clipping transit areas
illinois_boundary <- states(cb = TRUE, year = 2023) %>%
  filter(STUSPS == "IL") %>%
  st_transform(4326)  # Transform to WGS84
```

```{r load_existing_data}
## Load Existing Hub Data and Corridor Data

# Load the existing hub processing results (from the original analysis)
# We'll reuse the hub identification logic from the original script

# Load GTFS utility functions from extracted modules
source("R/gtfs_download.R")
source("R/gtfs_normalize.R")
source("R/gtfs_validate.R")
source("R/gtfs_processing.R")
source("R/spatial_validate.R")
source("R/spatial_clustering.R")
source("R/frequency_calc.R")
source("R/hub_identification.R")
source("R/hub_processing.R")
source("R/corridor_processing.R")
source("R/buffer_processing.R")
source("R/map_creation.R")
source("R/summary_stats.R")
```

```{r download_gtfs, results='hide'}
## Download and Process GTFS Data

# Define agency configurations
agency_configs <- list(
  list(name = "cta", url = "https://www.transitchicago.com/downloads/sch_data/google_transit.zip"),
  list(name = "pace", url = "https://www.pacebus.com/sites/default/files/2025-02/GTFS.zip"),
  list(name = "metra", url = "https://schedules.metrarail.com/gtfs/schedule.zip"),
  list(name = "metro_stl", url = "https://metrostlouis.org/Transit/google_transit.zip"),
  list(name = "cumtd", url = "http://developer.cumtd.com/gtfs/google_transit.zip"),
  list(name = "rmtd", url = "https://rmtd.org/rmtdgtfs/GTFS_FILES.zip")
)

# Process all GTFS data: download, normalize, validate, and combine
gtfs_data <- process_all_gtfs_data(agency_configs, validate = TRUE)

# Extract combined tables for easy access
all_stops <- gtfs_data$all_stops
all_routes <- gtfs_data$all_routes
all_trips <- gtfs_data$all_trips
all_stop_times <- gtfs_data$all_stop_times
all_calendar <- gtfs_data$all_calendar
all_calendar_dates <- gtfs_data$all_calendar_dates
validation_results <- gtfs_data$validation_results

# Keep individual agency data for direction exploration
cta_data <- gtfs_data$agency_data$cta
pace_data <- gtfs_data$agency_data$pace
metra_data <- gtfs_data$agency_data$metra
metro_stl_data <- gtfs_data$agency_data$metro_stl
cumtd_data <- gtfs_data$agency_data$cumtd
rmtd_data <- gtfs_data$agency_data$rmtd
```

```{r explore_direction_data, results='hide'}
## Explore direction_id availability in GTFS data

# Check if direction_id exists in trips data
cat("=== Checking direction_id availability ===\n\n")

agencies <- c("cta", "pace", "metra", "metro_stl", "cumtd", "rmtd")
for (agency in agencies) {
  trips_data <- switch(agency,
                      "cta" = cta_data$trips,
                      "pace" = pace_data$trips,
                      "metra" = metra_data$trips,
                      "metro_stl" = metro_stl_data$trips,
                      "cumtd" = cumtd_data$trips,
                      "rmtd" = rmtd_data$trips)

  if ("direction_id" %in% names(trips_data)) {
    cat(sprintf("%s: Has direction_id field\n", toupper(agency)))
    cat(sprintf("  - Total trips: %d\n", nrow(trips_data)))
    cat(sprintf("  - Trips with direction_id: %d\n", sum(!is.na(trips_data$direction_id))))
    cat(sprintf("  - Unique direction values: %s\n",
                paste(sort(unique(trips_data$direction_id)), collapse = ", ")))
  } else {
    cat(sprintf("%s: NO direction_id field\n", toupper(agency)))
  }
  cat("\n")
}

# If direction_id exists, add it to all_trips
if ("direction_id" %in% names(cta_data$trips) |
    "direction_id" %in% names(pace_data$trips) |
    "direction_id" %in% names(metra_data$trips) |
    "direction_id" %in% names(metro_stl_data$trips) |
    "direction_id" %in% names(cumtd_data$trips) |
    "direction_id" %in% names(rmtd_data$trips)) {

  # Ensure direction_id exists in all datasets (add NA if missing)
  for (data in list(cta_data, pace_data, metra_data, metro_stl_data, cumtd_data, rmtd_data)) {
    if (!"direction_id" %in% names(data$trips)) {
      data$trips[, direction_id := NA_integer_]
    }
  }

  # Rebuild all_trips with direction_id
  all_trips <- rbindlist(list(cta_data$trips, pace_data$trips, metra_data$trips, metro_stl_data$trips, cumtd_data$trips, rmtd_data$trips), fill = TRUE)

  cat("direction_id added to all_trips\n")
  cat(sprintf("Trips with direction_id: %d / %d (%.1f%%)\n",
              sum(!is.na(all_trips$direction_id)),
              nrow(all_trips),
              100 * sum(!is.na(all_trips$direction_id)) / nrow(all_trips)))
}
```


```{r process_hubs_UPDATED, results='hide'}
## Identify Public Transportation Hubs

# Identify all transit hubs (rail stations + qualifying bus hubs)
hub_results <- identify_all_hubs(
  all_stops, all_routes, all_trips,
  all_stop_times, all_calendar, all_calendar_dates
)

# Extract results
all_hubs_sf <- hub_results$all_hubs_sf
am_peak_bus_stops <- hub_results$am_peak_bus_stops
pm_peak_bus_stops <- hub_results$pm_peak_bus_stops
```

```{r process_corridors_and_buffers, results='hide'}
## Identify Corridors and Create Buffers

# Identify qualifying transit corridors
qualifying_corridor_stops_sf <- identify_qualifying_corridors(
  all_stops, am_peak_bus_stops, pm_peak_bus_stops
)

# Create corridor buffers (1/8 mile along street segments)
all_corridors_union_wgs84 <- create_corridor_buffers(
  qualifying_corridor_stops_sf, illinois_boundary
)

# Create hub buffers (1/2 mile around hubs)
hub_buffers <- create_hub_buffers(all_hubs_sf, illinois_boundary)

# Extract hub buffer components for map and calculations
all_hub_areas_wgs84 <- hub_buffers$all_hub_areas
half_mile_buffers_wgs84 <- hub_buffers$half_mile_buffers
cta_hubs_union <- hub_buffers$cta_hubs_union
pace_hubs_union <- hub_buffers$pace_hubs_union
metra_hubs_union <- hub_buffers$metra_hubs_union
metro_stl_hubs_union <- hub_buffers$metro_stl_hubs_union
cumtd_hubs_union <- hub_buffers$cumtd_hubs_union
rmtd_hubs_union <- hub_buffers$rmtd_hubs_union

# Combine all affected areas (hubs + corridors)
all_affected_areas_combined <- create_combined_buffers(
  all_hub_areas_wgs84, all_corridors_union_wgs84, illinois_boundary
)
```

```{r calculate_areas}
## Calculate Areas

# Calculate areas in square miles
hub_area_sqft <- st_area(all_hub_areas_wgs84)
hub_area_sqmi <- units::set_units(hub_area_sqft, "mi^2")

corridor_area_sqft <- st_area(all_corridors_union_wgs84)
corridor_area_sqmi <- units::set_units(corridor_area_sqft, "mi^2")

combined_area_sqft <- st_area(all_affected_areas_combined)
combined_area_sqmi <- units::set_units(combined_area_sqft, "mi^2")

# Total area covered by analysis
# Chicago MSA (6 IL counties): Cook: 953.6, DuPage: 336.5, Kane: 524.2, Lake: 470, McHenry: 611, Will: 849.2
# St. Louis MSA (3 IL counties): St. Clair: 674.6, Madison: 741.5, Monroe: 398.2
# Champaign-Urbana: Champaign County: 1,008
# Rockford: Winnebago County: 519
chicago_il_msa_area_sqmi <- 953.6 + 336.5 + 524.2 + 470 + 611 + 849.2
stlouis_il_msa_area_sqmi <- 674.6 + 741.5 + 398.2
champaign_area_sqmi <- 1008
rockford_area_sqmi <- 519
total_il_area_sqmi <- chicago_il_msa_area_sqmi + stlouis_il_msa_area_sqmi + champaign_area_sqmi + rockford_area_sqmi

# Calculate percentages (against total IL area covered)
pct_hubs <- as.numeric(hub_area_sqmi) / total_il_area_sqmi * 100
pct_corridors <- as.numeric(corridor_area_sqmi) / total_il_area_sqmi * 100
pct_combined <- as.numeric(combined_area_sqmi) / total_il_area_sqmi * 100

# Count hubs and routes
hub_counts <- table(all_hubs_sf$agency_name)
qualifying_corridor_stop_count <- nrow(qualifying_corridor_stops_sf)
```

## Interactive Map: Areas Affected by the Updated People Over Parking Act

```{r create_map}
# Create the interactive map
map <- create_interactive_map(
  all_hubs_sf,
  all_affected_areas_combined,
  cta_hubs_union,
  pace_hubs_union,
  metra_hubs_union,
  metro_stl_hubs_union,
  cumtd_hubs_union,
  rmtd_hubs_union,
  all_corridors_union_wgs84,
  center_lng = -87.6079,
  center_lat = 41.8917,
  zoom = 9
)

# Display the map
map
```

This analysis examines the potential impact of new legislation passed in Illinois (SB2111) on Chicagoland.

According to the updated bill [10400SB2111ham003](https://www.ilga.gov/documents/legislation/104/SB/PDF/10400SB2111ham003.pdf), minimum parking requirements are prohibited for development projects located within:

- **1/2 mile of public transportation hubs**, defined as:
  - (i) A rail transit station
  - (ii) A boat or ferry terminal served by either a bus connection stop or rail transit station
  - (iii) An intersection of 2 or more bus routes with a **combined frequency** of service interval of 15 minutes or less during peak commute periods

- **1/8 mile of public transportation corridors**, defined as:
  - A street on which there is **one or more bus routes** with a **combined frequency** of bus service interval of 15 minutes or less during the morning and afternoon peak commute periods

### Analysis Methodology

This analysis implements the following methodology to identify qualifying transit hubs and corridors:

**Peak Period Definition:**

- Morning peak: 7:00 AM - 9:00 AM (120 minutes)
- Afternoon peak: 4:00 PM - 6:00 PM (120 minutes)
- Service is analyzed separately for each period; locations qualify if they meet frequency thresholds in **either** AM **or** PM

**Stop Clustering (Bus Hubs Only):**

- Bus stops within **150 feet** of each other are spatially clustered to represent physical intersections
- This prevents overcounting stops at the same street corner and aligns with the statutory concept of "an intersection of 2 or more bus routes"
- Clustering uses Illinois State Plane East projection (EPSG:3435) for accurate distance measurement

**Route Overlap Verification (Bus Hubs Only):**

- After clustering, we verify that routes actually overlap at the same physical intersection or street
- Stop names (e.g., "Jackson & Lotus", "Oak Ave & Davis St") are parsed to extract street names
- A cluster qualifies only if **2 or more routes share at least one common street name**
- This ensures routes truly intersect at the location, not just have nearby stops within 150 feet
- Example: Route A stops at "State & Madison", Route B stops at "State & Monroe" (both within 150ft) → they share "State" street → overlap verified

**Combined Frequency Calculation:**

- For each stop cluster (hubs) or individual stop (corridors), we count total trips across all routes during each peak period
- Combined service interval = peak period duration (120 min) ÷ total trips
- Example: 8 trips in 2 hours = 120 ÷ 8 = **15 minute average interval**

**Qualification Criteria:**

- **Bus Hubs**: Must have **2 or more routes** AND **combined frequency ≤ 15 minutes** in at least one peak period AND **routes must overlap on same street/intersection**
- **Bus Corridors**: Must have **1 or more routes** AND **combined frequency ≤ 15 minutes** in at least one peak period
- **Rail Hubs**: All rail stations within Illinois automatically qualify (CTA rail, Metra, and Metro St. Louis MetroLink)

**Direction Handling:**

- If GTFS `direction_id` data is available, routes are analyzed by direction (northbound/southbound, eastbound/westbound)
- This provides more accurate service frequency calculations at directional stops

**Geographic Boundaries and Clipping:**

- All transit hub and corridor buffers are clipped to Illinois state boundaries
- This ensures parking mandate relief applies only to areas within Illinois jurisdiction
- Metro St. Louis transit system operates across the Illinois-Missouri border; only Illinois portions of hub/corridor buffers are included in the analysis
- Metra serves some stations in Wisconsin (Kenosha County); these are excluded from the analysis (latitude filter at 42.5°)
- Clipping is performed after buffer creation using the U.S. Census TIGER/Line state boundary for Illinois

**Data Sources:**

- Chicago area: CTA, Pace, and Metra GTFS (General Transit Feed Specification) data
- St. Louis area: Metro St. Louis GTFS data (includes MetroLink light rail and MetroBus)
  - Note: Metro St. Louis operates in both Missouri and Illinois; only Illinois portions are included after geographic clipping
- Champaign-Urbana: CUMTD (Champaign-Urbana Mass Transit District) GTFS data
- Rockford: RMTD (Rockford Mass Transit District) GTFS data
- TIGER/Line street network data from U.S. Census Bureau via tigris package
- Analysis covers 11 Illinois counties:
  - Chicago metro: Cook, DuPage, Kane, Lake, McHenry, and Will
  - St. Louis metro: St. Clair, Madison, and Monroe
  - Champaign-Urbana: Champaign
  - Rockford: Winnebago



```{r summary_stats, include=FALSE}
# Generate all summary statistics
stats <- generate_summary_statistics(all_hubs_sf, qualifying_corridor_stops_sf)

# Extract summary variables for use in inline R code
bus_hub_summary <- stats$bus_hub_summary
corridor_summary <- stats$corridor_summary
rail_hub_count <- stats$rail_hub_count
total_hubs <- stats$total_hubs
cta_hub <- stats$cta_hub
pace_hub <- stats$pace_hub
metro_stl_hub <- stats$metro_stl_hub
cumtd_hub <- stats$cumtd_hub
rmtd_hub <- stats$rmtd_hub
cta_corridor <- stats$cta_corridor
pace_corridor <- stats$pace_corridor
metro_stl_corridor <- stats$metro_stl_corridor
cumtd_corridor <- stats$cumtd_corridor
rmtd_corridor <- stats$rmtd_corridor
rail_hub_counts <- stats$rail_hub_counts
qualifying_bus_hubs <- stats$qualifying_bus_hubs
rail_stops <- stats$rail_stops
qualifying_corridor_stops <- stats$qualifying_corridor_stops
```

## Summary Statistics

### Bus Transit Hubs

**Methodology:** Stops clustered at 150 ft radius; qualifies if 2+ routes AND combined frequency ≤15 min in EITHER AM (7-9am) or PM (4-6pm) peak period.

**CTA:**

- Bus hub stops: **`r cta_hub$total_stops`** (in `r cta_hub$unique_clusters` clusters)
- Average routes per cluster: **`r sprintf("%.1f", cta_hub$avg_routes_am)` (AM)** / **`r sprintf("%.1f", cta_hub$avg_routes_pm)` (PM)**
- Average service interval: **`r sprintf("%.1f", cta_hub$avg_interval_am)` min (AM)** / **`r sprintf("%.1f", cta_hub$avg_interval_pm)` min (PM)**

**Pace:**

- Bus hub stops: **`r pace_hub$total_stops`** (in `r pace_hub$unique_clusters` clusters)
- Average routes per cluster: **`r sprintf("%.1f", pace_hub$avg_routes_am)` (AM)** / **`r sprintf("%.1f", pace_hub$avg_routes_pm)` (PM)**
- Average service interval: **`r sprintf("%.1f", pace_hub$avg_interval_am)` min (AM)** / **`r sprintf("%.1f", pace_hub$avg_interval_pm)` min (PM)**

**Metro St. Louis:**

- Bus hub stops: **`r if(nrow(metro_stl_hub) > 0) metro_stl_hub$total_stops else 0`** (in `r if(nrow(metro_stl_hub) > 0) metro_stl_hub$unique_clusters else 0` clusters)
- Average routes per cluster: **`r if(nrow(metro_stl_hub) > 0) sprintf("%.1f", metro_stl_hub$avg_routes_am) else "N/A"` (AM)** / **`r if(nrow(metro_stl_hub) > 0) sprintf("%.1f", metro_stl_hub$avg_routes_pm) else "N/A"` (PM)**
- Average service interval: **`r if(nrow(metro_stl_hub) > 0) sprintf("%.1f", metro_stl_hub$avg_interval_am) else "N/A"` min (AM)** / **`r if(nrow(metro_stl_hub) > 0) sprintf("%.1f", metro_stl_hub$avg_interval_pm) else "N/A"` min (PM)**

**Champaign-Urbana MTD:**

- Bus hub stops: **`r if(nrow(cumtd_hub) > 0) cumtd_hub$total_stops else 0`** (in `r if(nrow(cumtd_hub) > 0) cumtd_hub$unique_clusters else 0` clusters)
- Average routes per cluster: **`r if(nrow(cumtd_hub) > 0) sprintf("%.1f", cumtd_hub$avg_routes_am) else "N/A"` (AM)** / **`r if(nrow(cumtd_hub) > 0) sprintf("%.1f", cumtd_hub$avg_routes_pm) else "N/A"` (PM)**
- Average service interval: **`r if(nrow(cumtd_hub) > 0) sprintf("%.1f", cumtd_hub$avg_interval_am) else "N/A"` min (AM)** / **`r if(nrow(cumtd_hub) > 0) sprintf("%.1f", cumtd_hub$avg_interval_pm) else "N/A"` min (PM)**

**Rockford MTD:**

- Bus hub stops: **`r if(nrow(rmtd_hub) > 0) rmtd_hub$total_stops else 0`** (in `r if(nrow(rmtd_hub) > 0) rmtd_hub$unique_clusters else 0` clusters)
- Average routes per cluster: **`r if(nrow(rmtd_hub) > 0) sprintf("%.1f", rmtd_hub$avg_routes_am) else "N/A"` (AM)** / **`r if(nrow(rmtd_hub) > 0) sprintf("%.1f", rmtd_hub$avg_routes_pm) else "N/A"` (PM)**
- Average service interval: **`r if(nrow(rmtd_hub) > 0) sprintf("%.1f", rmtd_hub$avg_interval_am) else "N/A"` min (AM)** / **`r if(nrow(rmtd_hub) > 0) sprintf("%.1f", rmtd_hub$avg_interval_pm) else "N/A"` min (PM)**

**Rail Stations:** `r rail_hub_count`
- CTA: `r if("cta" %in% names(rail_hub_counts)) rail_hub_counts["cta"] else 0`
- Metra: `r if("metra" %in% names(rail_hub_counts)) rail_hub_counts["metra"] else 0`
- Metro STL: `r if("metro_stl" %in% names(rail_hub_counts)) rail_hub_counts["metro_stl"] else 0`

**Total Transit Hubs:** `r formatC(total_hubs, format="d", big.mark=",")`

### Bus Corridors

**Methodology:** Individual stops (no clustering); qualifies if combined frequency ≤15 min in EITHER AM (7-9am) or PM (4-6pm) peak period.

**CTA:**

- Corridor stops: **`r formatC(cta_corridor$total_stops, format="d", big.mark=",")`**
- Average routes per stop: **`r sprintf("%.1f", cta_corridor$avg_routes_am)` (AM)** / **`r sprintf("%.1f", cta_corridor$avg_routes_pm)` (PM)**
- Average service interval: **`r sprintf("%.1f", cta_corridor$avg_interval_am)` min (AM)** / **`r sprintf("%.1f", cta_corridor$avg_interval_pm)` min (PM)**

**Pace:**

- Corridor stops: **`r formatC(pace_corridor$total_stops, format="d", big.mark=",")`**
- Average routes per stop: **`r sprintf("%.1f", pace_corridor$avg_routes_am)` (AM)** / **`r sprintf("%.1f", pace_corridor$avg_routes_pm)` (PM)**
- Average service interval: **`r sprintf("%.1f", pace_corridor$avg_interval_am)` min (AM)** / **`r sprintf("%.1f", pace_corridor$avg_interval_pm)` min (PM)**

**Metro St. Louis:**

- Corridor stops: **`r if(nrow(metro_stl_corridor) > 0) formatC(metro_stl_corridor$total_stops, format="d", big.mark=",") else "0"`**
- Average routes per stop: **`r if(nrow(metro_stl_corridor) > 0) sprintf("%.1f", metro_stl_corridor$avg_routes_am) else "N/A"` (AM)** / **`r if(nrow(metro_stl_corridor) > 0) sprintf("%.1f", metro_stl_corridor$avg_routes_pm) else "N/A"` (PM)**
- Average service interval: **`r if(nrow(metro_stl_corridor) > 0) sprintf("%.1f", metro_stl_corridor$avg_interval_am) else "N/A"` min (AM)** / **`r if(nrow(metro_stl_corridor) > 0) sprintf("%.1f", metro_stl_corridor$avg_interval_pm) else "N/A"` min (PM)**

**Champaign-Urbana MTD:**

- Corridor stops: **`r if(nrow(cumtd_corridor) > 0) formatC(cumtd_corridor$total_stops, format="d", big.mark=",") else "0"`**
- Average routes per stop: **`r if(nrow(cumtd_corridor) > 0) sprintf("%.1f", cumtd_corridor$avg_routes_am) else "N/A"` (AM)** / **`r if(nrow(cumtd_corridor) > 0) sprintf("%.1f", cumtd_corridor$avg_routes_pm) else "N/A"` (PM)**
- Average service interval: **`r if(nrow(cumtd_corridor) > 0) sprintf("%.1f", cumtd_corridor$avg_interval_am) else "N/A"` min (AM)** / **`r if(nrow(cumtd_corridor) > 0) sprintf("%.1f", cumtd_corridor$avg_interval_pm) else "N/A"` min (PM)**

**Rockford MTD:**

- Corridor stops: **`r if(nrow(rmtd_corridor) > 0) formatC(rmtd_corridor$total_stops, format="d", big.mark=",") else "0"`**
- Average routes per stop: **`r if(nrow(rmtd_corridor) > 0) sprintf("%.1f", rmtd_corridor$avg_routes_am) else "N/A"` (AM)** / **`r if(nrow(rmtd_corridor) > 0) sprintf("%.1f", rmtd_corridor$avg_routes_pm) else "N/A"` (PM)**
- Average service interval: **`r if(nrow(rmtd_corridor) > 0) sprintf("%.1f", rmtd_corridor$avg_interval_am) else "N/A"` min (AM)** / **`r if(nrow(rmtd_corridor) > 0) sprintf("%.1f", rmtd_corridor$avg_interval_pm) else "N/A"` min (PM)**

### Geographic Coverage

- **Hub buffer area (1/2 mile):** `r sprintf("%.1f", as.numeric(hub_area_sqmi))` sq mi (`r sprintf("%.2f%%", pct_hubs)` of total area)
- **Corridor buffer area (1/8 mile):** `r sprintf("%.1f", as.numeric(corridor_area_sqmi))` sq mi (`r sprintf("%.2f%%", pct_corridors)` of total area)
- **Combined affected area:** `r sprintf("%.1f", as.numeric(combined_area_sqmi))` sq mi (`r sprintf("%.2f%%", pct_combined)` of total area)
- **Total Illinois area analyzed:**
  - Chicago MSA (6 counties): `r sprintf("%.1f", chicago_il_msa_area_sqmi)` sq mi
  - St. Louis MSA (3 IL counties): `r sprintf("%.1f", stlouis_il_msa_area_sqmi)` sq mi
  - Champaign-Urbana (1 county): `r sprintf("%.1f", champaign_area_sqmi)` sq mi
  - Rockford (1 county): `r sprintf("%.1f", rockford_area_sqmi)` sq mi
  - **Total: `r sprintf("%.1f", total_il_area_sqmi)` sq mi**

**Note**: Area calculations reflect only portions within Illinois state boundaries. Cross-border transit services (Metro St. Louis in Missouri, Metra in Wisconsin) are excluded through geographic clipping.

## Notes on Updated Methodology

This analysis implements the following improvements to align with SB 2111's statutory language:

1. **Split AM/PM Peak Periods**: Service is analyzed separately for morning (7-9am) and afternoon (4-6pm) peak periods, then combined using "either" logic—a location qualifies if it meets the frequency threshold in **either** AM **or** PM.

2. **Stop Clustering (Hubs Only)**: Bus stops within **150 feet** are clustered together to represent physical intersections. This prevents overcounting stops at the same intersection and better reflects the statutory concept of "an intersection of 2 or more bus routes."

3. **Direction-Aware (if available)**: If `direction_id` is present in GTFS data, the analysis accounts for directionality (northbound vs southbound) when calculating service frequency.

4. **Qualification Criteria**:
   - **Bus Hubs**: Must have **2+ routes** AND **combined frequency ≤15 minutes** in at least one peak period
   - **Bus Corridors**: Must have **1+ routes** AND **combined frequency ≤15 minutes** in at least one peak period

5. **Transparent Metrics**: Each hub and corridor stop now includes diagnostic information showing AM/PM service levels, making it easy to verify which locations qualify and why.

6. **Illinois Boundary Clipping**: All hub and corridor buffer areas are clipped to Illinois state boundaries after calculation. This is critical for cross-border transit agencies (Metro St. Louis, Metra) to ensure parking mandate relief applies only within Illinois jurisdiction. Area calculations reflect only the Illinois portions of buffer zones.
